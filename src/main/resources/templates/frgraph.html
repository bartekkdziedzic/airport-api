<!DOCTYPE html>
<html>
<head>
    <title>Wykres Odlot√≥w FR24</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div>
    <label for="depIataInput">Enter Departure Airport City:</label>
    <input type="text" id="depIataInput" oninput="showHint()" />
    <div id="suggestions"></div>
    <button onclick="fetchFrGraph()">Generate Graph</button>
</div>
<div>
    <button onclick="navigateToGraph()">Go to default Graph View</button>
</div>
<canvas id="departureChart"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var city = /*[[${city}]]*/ 'defaultCity';
    /*]]>*/
</script>
<script>
    let airportData = [];

    // Read airport data from the text file
    fetch('/api/airport-codes.txt')
        .then(response => response.text())
        .then(data => {
            airportData = data.trim().split('\n').map(line => {
                const parts = line.split(',');
                return {
                    iata: parts[9].trim(),
                    municipality: parts[7].trim(),
                };
            }).filter(airport => airport.iata !== '');  // Filter out airports with empty IATA code
            console.log(airportData);  // Log the fetched airport data to the console
        });

    function showHint() {
        const input = document.getElementById('depIataInput').value.toUpperCase();
        const suggestionsDiv = document.getElementById('suggestions');

        // Clear previous suggestions
        suggestionsDiv.innerHTML = '';

        // Filter and display matching municipality names
        const matchingAirports = airportData.filter(airport => airport.municipality.toUpperCase().startsWith(input));
        matchingAirports.forEach(airport => {
            const suggestion = document.createElement('div');
            suggestion.textContent = `${airport.iata} - ${airport.municipality}`;
            suggestion.onclick = () => {
                document.getElementById('depIataInput').value = airport.municipality;
                suggestionsDiv.innerHTML = '';
                // Store the selected IATA code for fetching the graph
                document.getElementById('depIataInput').dataset.selectedIata = airport.iata;
            };
            suggestionsDiv.appendChild(suggestion);
        });
    }

    function fetchFrGraph() {
        var iata = document.getElementById('depIataInput').dataset.selectedIata;
        fetch('/api/frgraph/' + iata)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('departureChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data),
                        datasets: [{
                            label: 'People arriving',
                            data: Object.values(data),
                            fill: false,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day'
                                }
                            }
                        }
                    }
                });
            });
    }

    function navigateToGraph() {
        window.location.href = '/graph';
    }

</script>
</body>
</html>
